<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrow WASM MBD Test Runner</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.loading { background: #fff3cd; color: #856404; }
        .status.ready { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .run-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .run-button:hover { background: #0056b3; }
        .run-button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .test-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-results {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        #logs {
            max-height: 300px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Arrow WASM Model-Based Test Runner</h1>
        <p>Testing WASM module with 261 generated MBD test cases</p>
        
        <div id="wasm-status" class="status loading">
            ‚è≥ Loading WASM module...
        </div>
        
        <button id="run-basic" onclick="runBasicTests()" class="run-button" disabled>
            üß™ Run Basic Tests
        </button>
        <button id="run-mbd" onclick="runMBDTestSuite()" class="run-button" disabled>
            üéØ Run MBD Test Suite
        </button>
        <button onclick="clearResults()" class="run-button">
            üßπ Clear Results
        </button>
    </div>
    
    <div id="test-results" class="test-grid">
        <div class="test-card">
            <h3>Test Output</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script type="module">
        // Global state
        window.wasmLoaded = false;
        window.wasmModule = null;
        window.testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            results: []
        };

        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            const logElement = document.getElementById('logs');
            logElement.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // Load WASM module
        async function loadWASM() {
            try {
                log('Loading WASM module from /pkg/arrow_wasm.js...');
                
                // Import the WASM module
                const wasmModule = await import('/pkg/arrow_wasm.js');
                log('WASM JS bindings loaded, initializing...');
                
                // Initialize WASM - this loads the actual WASM binary
                await wasmModule.default();
                log('WASM binary loaded, calling init function...');
                
                // Initialize the module - this calls the Rust init function
                wasmModule.init();
                log('WASM init function called successfully...');
                
                window.wasmModule = wasmModule;
                window.wasmLoaded = true;
                
                log('WASM module loaded and initialized successfully!', 'success');
                
                // Update UI
                const statusEl = document.getElementById('wasm-status');
                statusEl.className = 'status ready';
                statusEl.textContent = '‚úÖ WASM module loaded and ready';
                
                // Enable buttons
                document.getElementById('run-basic').disabled = false;
                document.getElementById('run-mbd').disabled = false;
                
                // Run basic validation
                await validateWASMModule();
                
                return true;
                
            } catch (error) {
                log(`Failed to load WASM module: ${error.message}`, 'error');
                console.error('WASM loading error:', error);
                
                // Update UI
                const statusEl = document.getElementById('wasm-status');
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå Failed to load WASM module';
                
                return false;
            }
        }

        // Validate WASM module basic functionality
        async function validateWASMModule() {
            try {
                log('Validating WASM module basic functionality...');
                
                const wasm = window.wasmModule;
                
                // Test version function
                const version = wasm.get_version();
                log(`WASM module version: ${version}`, 'success');
                
                // Test LZ4 support
                const lz4Supported = wasm.is_lz4_supported();
                log(`LZ4 compression support: ${lz4Supported}`, 'success');
                
                // Test table count
                const tableCount = wasm.get_table_count();
                log(`Initial table count: ${tableCount}`, 'success');
                
                // Test memory stats
                const memStats = wasm.get_memory_stats();
                log(`Memory stats: ${JSON.stringify(memStats)}`, 'success');
                
                log('Basic WASM validation completed successfully!', 'success');
                return true;
                
            } catch (error) {
                log(`WASM validation failed: ${error.message}`, 'error');
                return false;
            }
        }

        // Run basic functionality tests
        window.runBasicTests = async function() {
            if (!window.wasmLoaded) {
                log('WASM module not loaded!', 'error');
                return;
            }

            log('Running basic functionality tests...');
            
            const wasm = window.wasmModule;
            let passed = 0;
            let failed = 0;

            try {
                // Test 1: Version check
                log('Test 1: Version check');
                const version = wasm.get_version();
                if (version && typeof version === 'string') {
                    log(`‚úÖ Version test passed: ${version}`, 'success');
                    passed++;
                } else {
                    log('‚ùå Version test failed', 'error');
                    failed++;
                }

                // Test 2: LZ4 support
                log('Test 2: LZ4 support check');
                const lz4Supported = wasm.is_lz4_supported();
                if (typeof lz4Supported === 'boolean') {
                    log(`‚úÖ LZ4 test passed: ${lz4Supported}`, 'success');
                    passed++;
                } else {
                    log('‚ùå LZ4 test failed', 'error');
                    failed++;
                }

                // Test 3: Memory stats
                log('Test 3: Memory stats');
                const memStats = wasm.get_memory_stats();
                if (memStats && typeof memStats === 'object') {
                    log(`‚úÖ Memory stats test passed`, 'success');
                    passed++;
                } else {
                    log('‚ùå Memory stats test failed', 'error');
                    failed++;
                }

                // Test 4: Table operations
                log('Test 4: Table operations');
                const initialCount = wasm.get_table_count();
                if (typeof initialCount === 'number') {
                    log(`‚úÖ Table count test passed: ${initialCount}`, 'success');
                    passed++;
                } else {
                    log('‚ùå Table count test failed', 'error');
                    failed++;
                }

                log(`Basic tests completed: ${passed} passed, ${failed} failed`, 
                    failed === 0 ? 'success' : 'error');

                return { total: passed + failed, passed, failed };

            } catch (error) {
                log(`Basic tests failed with error: ${error.message}`, 'error');
                return { total: 1, passed: 0, failed: 1, error: error.message };
            }
        };

        // Run MBD test suite (placeholder - will be enhanced)
        window.runMBDTestSuite = async function() {
            if (!window.wasmLoaded) {
                log('WASM module not loaded!', 'error');
                return;
            }

            log('Running MBD test suite...');
            
            // This is a simplified version - real implementation would:
            // 1. Load all generated test specs from /generated/
            // 2. Execute each test case
            // 3. Validate model coverage
            // 4. Generate traceability reports

            const testResults = {
                total: 261,  // Total from model coverage
                passed: 0,
                failed: 0,
                coverage: {
                    states: 0,
                    transitions: 0
                }
            };

            try {
                // Simulate running MBD tests
                log('Loading MBD test specifications...');
                
                // Run basic tests as part of MBD suite
                const basicResults = await window.runBasicTests();
                testResults.passed = basicResults.passed;
                testResults.failed = basicResults.failed;
                
                // Calculate coverage (simplified)
                const coveragePercent = (testResults.passed / testResults.total) * 100;
                log(`MBD test coverage: ${coveragePercent.toFixed(1)}%`, 
                    coveragePercent >= 90 ? 'success' : 'error');

                log(`MBD test suite completed: ${testResults.passed}/${testResults.total} passed`, 
                    testResults.failed === 0 ? 'success' : 'error');

                // Store results globally for browser automation
                window.testResults = testResults;
                
                return testResults;

            } catch (error) {
                log(`MBD test suite failed: ${error.message}`, 'error');
                return { 
                    total: 261, 
                    passed: 0, 
                    failed: 261, 
                    error: error.message 
                };
            }
        };

        // Run basic functionality test (for browser automation)
        window.runBasicFunctionalityTest = async function() {
            return await window.runBasicTests();
        };

        // Clear results
        window.clearResults = function() {
            document.getElementById('logs').innerHTML = '';
            window.testResults = { total: 0, passed: 0, failed: 0, results: [] };
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            log('Page loaded, initializing WASM test runner...');
            await loadWASM();
        });

    </script>
</body>
</html>