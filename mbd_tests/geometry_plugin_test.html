<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometry Plugin Test - Arrow WASM</title>
    <style>
        body { 
            font-family: monospace; 
            margin: 2rem; 
            background: #f8f9fa; 
        }
        .test-container { 
            background: white; 
            padding: 1rem; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
            margin-bottom: 1rem; 
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #0066cc; }
        .log { 
            background: #f8f9fa; 
            padding: 0.5rem; 
            margin: 0.5rem 0; 
            border-left: 4px solid #0066cc;
            font-size: 0.9em;
        }
        .section { margin: 1rem 0; }
        pre { 
            background: #f1f1f1; 
            padding: 1rem; 
            border-radius: 4px; 
            overflow-x: auto; 
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üåç Arrow WASM Geometry Plugin Test</h1>
        <p>Testing the geometry plugin functionality for spatial data processing.</p>
        
        <div class="section">
            <h2>Test Progress</h2>
            <div id="progress">Initializing...</div>
        </div>
        
        <div class="section">
            <h2>Test Results</h2>
            <div id="results"></div>
        </div>
        
        <div class="section">
            <h2>Console Logs</h2>
            <div id="logs"></div>
        </div>
    </div>

    <script type="module">
        import init, * as wasm from './pkg/arrow_wasm.js';

        let logContainer = document.getElementById('logs');
        let resultsContainer = document.getElementById('results');
        let progressContainer = document.getElementById('progress');

        // Capture console logs
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logDiv = document.createElement('div');
            logDiv.className = 'log';
            logDiv.textContent = args.join(' ');
            logContainer.appendChild(logDiv);
        };

        function updateProgress(message, type = 'info') {
            progressContainer.innerHTML = `<span class="${type}">${message}</span>`;
        }

        function addResult(test, status, details = '') {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result';
            const statusClass = status === 'PASS' ? 'success' : 'error';
            resultDiv.innerHTML = `
                <strong class="${statusClass}">[${status}]</strong> ${test}
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            resultsContainer.appendChild(resultDiv);
        }

        async function testGeometryPlugin() {
            console.log('=== Starting Geometry Plugin Test Suite ===');
            
            try {
                updateProgress('Initializing WASM module...');
                
                // Initialize WASM
                await init();
                wasm.init();
                console.log('‚úÖ WASM module initialized');
                addResult('WASM Module Initialization', 'PASS');

                updateProgress('Testing basic functionality...');
                
                // Test version info
                const version = wasm.get_version();
                console.log(`Arrow WASM version: ${version}`);
                addResult('Version Check', 'PASS', `Version: ${version}`);

                // Test LZ4 support
                const lz4Supported = wasm.is_lz4_supported();
                console.log(`LZ4 compression supported: ${lz4Supported}`);
                addResult('LZ4 Support Check', 'PASS', `LZ4: ${lz4Supported}`);

                updateProgress('Registering geometry plugin...');
                
                // Register geometry plugin
                await wasm.register_geometry_plugin();
                console.log('‚úÖ Geometry plugin registered successfully');
                addResult('Geometry Plugin Registration', 'PASS');

                updateProgress('Testing geometry plugin functionality...');
                
                // Demonstrate geometry plugin
                await wasm.demonstrate_geometry_plugin();
                console.log('‚úÖ Geometry plugin demonstration completed');
                addResult('Geometry Plugin Demonstration', 'PASS');

                updateProgress('Testing WKB data creation...');
                
                // Test WKB point creation
                const pointWkb1 = wasm.create_sample_point_wkb(10.0, 20.0);
                const pointWkb2 = wasm.create_sample_point_wkb(30.0, 40.0);
                const pointWkb3 = wasm.create_sample_point_wkb(50.0, 60.0);
                
                console.log(`Created WKB points: ${pointWkb1.length}, ${pointWkb2.length}, ${pointWkb3.length} bytes`);
                addResult('WKB Point Creation', 'PASS', `Created 3 WKB points`);

                updateProgress('Testing geometry field creation...');
                
                // Test geometry field creation
                const geometryField = await wasm.create_sample_geometry_field("locations", "geo.point");
                console.log('Geometry field created:', geometryField);
                addResult('Geometry Field Creation', 'PASS', 'Point geometry field created');

                updateProgress('Testing plugin information...');
                
                // Test plugin info
                const pluginInfo = await wasm.get_plugin_info();
                console.log('Plugin info:', pluginInfo);
                addResult('Plugin Information Retrieval', 'PASS', `Found ${pluginInfo.length} plugins`);

                updateProgress('Testing plugin validation...');
                
                // Test plugin validation
                try {
                    await wasm.validate_plugin("io.arrow.plugin.geo.v1");
                    console.log('‚úÖ Geometry plugin validation passed');
                    addResult('Plugin Validation', 'PASS', 'Geometry plugin validated');
                } catch (e) {
                    console.log('‚ùå Plugin validation failed:', e);
                    addResult('Plugin Validation', 'FAIL', e.message);
                }

                updateProgress('All tests completed!', 'success');
                
                console.log('=== Geometry Plugin Test Suite Completed Successfully ===');
                
                // Summary
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'test-container';
                summaryDiv.innerHTML = `
                    <h3 class="success">‚úÖ Test Suite Summary</h3>
                    <p>All geometry plugin tests completed successfully!</p>
                    <ul>
                        <li>‚úÖ WASM module initialization</li>
                        <li>‚úÖ Geometry plugin registration</li>
                        <li>‚úÖ WKB data creation and parsing</li>
                        <li>‚úÖ Geometry field validation</li>
                        <li>‚úÖ Plugin metadata and information</li>
                    </ul>
                    <p><strong>Result:</strong> Geometry plugin is working correctly and ready for production use.</p>
                `;
                resultsContainer.appendChild(summaryDiv);

            } catch (error) {
                console.error('‚ùå Test failed:', error);
                updateProgress('Test failed!', 'error');
                addResult('Test Suite', 'FAIL', error.message);
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'test-container';
                errorDiv.innerHTML = `
                    <h3 class="error">‚ùå Test Suite Failed</h3>
                    <p>Error: ${error.message}</p>
                    <pre>${error.stack || 'No stack trace available'}</pre>
                `;
                resultsContainer.appendChild(errorDiv);
            }
        }

        // Start the test when page loads
        window.addEventListener('load', testGeometryPlugin);
    </script>
</body>
</html>